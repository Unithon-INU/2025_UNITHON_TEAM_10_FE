
## 추론 후처리: NMS (Non-Maximum Suppression)

모델이 8400개의 객체 후보를 출력한 후에는 중복되는 박스를 제거하고 최종적인 검출 결과를 선별하는 후처리 과정이 필요합니다. 이 과정의 핵심은 **NMS (Non-Maximum Suppression, 비최대 억제)** 알고리즘이며, **IoU (Intersection over Union)** 지표를 활용합니다.

### 1. NMS (Non-Maximum Suppression) 란?

NMS는 객체 검출 모델이 하나의 객체에 대해 여러 개의 중복된 바운딩 박스(Bounding Box)를 예측할 때, 이들 중 가장 정확하다고 판단되는 하나의 박스만 남기고 나머지를 제거하는 알고리즘입니다. 예를 들어, 한 사람을 검출할 때 여러 개의 박스가 사람 주변에 그려질 수 있는데, NMS는 이 중에서 가장 적절한 박스 하나만 선택하도록 돕습니다.

### 2. IoU (Intersection over Union) 란?

IoU는 두 개의 바운딩 박스가 얼마나 겹쳐지는지를 측정하는 지표입니다. 계산 방식은 다음과 같습니다.

$$\text{IoU} = \frac{\text{두 박스의 교집합 면적}}{\text{두 박스의 합집합 면적}}$$

* **교집합 면적 (Intersection)**: 두 박스가 겹치는 영역의 면적
* **합집합 면적 (Union)**: 두 박스가 차지하는 전체 영역의 면적 (교집합 + 각 박스 고유 영역)

IoU 값은 0과 1 사이의 값을 가지며, 1에 가까울수록 두 박스가 완전히 겹친다는 의미이고, 0에 가까울수록 전혀 겹치지 않는다는 의미입니다. 객체 검출에서는 일반적으로 **IoU 임계값 (IoU Threshold)**을 설정하여 특정 값 이상으로 겹치는 박스들을 중복으로 간주합니다.

### 3. IoU를 통한 NMS 동작 원리

제공된 코드 스니펫은 NMS 알고리즘의 핵심적인 부분 중 하나를 보여줍니다. NMS는 일반적으로 다음과 같은 단계로 동작합니다:

1.  **신뢰도 점수(Confidence Score) 기준으로 정렬**: 모델이 출력한 모든 바운딩 박스 후보들을 각 박스의 신뢰도 점수(해당 객체가 존재할 확률)를 기준으로 내림차순 정렬합니다. 가장 높은 점수를 가진 박스부터 처리합니다.
2.  **가장 높은 점수의 박스 선택**: 정렬된 리스트에서 가장 높은 신뢰도 점수를 가진 박스를 최종 결과 목록에 추가합니다.
3.  **겹치는 박스 제거 (IoU 활용)**:
    * 현재 선택된(가장 높은 점수의) 박스와 나머지 모든 박스들 간의 IoU를 계산합니다.
    * 만약 어떤 박스와의 IoU가 미리 설정된 **IoU 임계값 (`iouThreshold`)** 이상이면, 그 박스는 현재 선택된 박스와 중복된다고 판단하고 해당 박스를 **비활성화(`active[j] = false`)**하여 최종 결과 목록에서 제외합니다.
    * 제공된 코드는 이 제거 로직을 구현한 것으로 볼 수 있습니다.
        ```kotlin
                if (active[j]) { // 아직 활성화된 (제거되지 않은) 박스라면
                    val iou = calculateIoU(
                        sortedCandidates[i].boundingBox, // 현재 검토 중인 (가장 높은 점수의) 박스
                        sortedCandidates[j].boundingBox  // 비교 대상 박스
                    )
                    if (iou >= iouThreshold) { // 두 박스가 IoU 임계값 이상으로 겹친다면
                        active[j] = false // 비교 대상 박스를 비활성화 (제거)
                    }
                }
        ```
4.  **반복**: 최종 결과 목록에 추가되지 않은(활성화된) 박스들 중에서 다시 가장 높은 신뢰도 점수를 가진 박스를 선택하고 3단계를 반복합니다. 이 과정은 더 이상 처리할 박스가 없을 때까지 계속됩니다.

이 과정을 통해 NMS는 하나의 객체에 대해 단 하나의 최적화된 바운딩 박스만을 남겨, 검출 결과의 정확성과 시각적 명확성을 높입니다.
